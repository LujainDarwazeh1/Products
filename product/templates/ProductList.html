<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product List</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        th, td {
            width: 250px;
            height: 100px;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            background-color: white;
            padding: 20px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .modal input {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
        }
        .modal button {
            width: 45%;

        }
    </style>
</head>

<body>

    <h1 style="text-align: center;">Products List</h1>
    <br><br>

    <button onclick="AddProductPopup()">Add New Product</button>

    <table border="1">
        <thead>
            <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="productslist">

        </tbody>
    </table>


    <div id="addProductModal" class="modal">
        <h3>Add New Product</h3>
        <input type="text" id="productName" placeholder="Enter product name">
        <input type="number" id="productPrice" placeholder="Enter price">
        <input type="number" id="productStock" placeholder="Enter stock">
        <input type="url" id="productImageUrl" placeholder="Enter image URL">
        <button onclick="closePopup()">Cancel</button>
        <button onclick="addProduct()">Add</button>
    </div>


    <div id="updateProductModal" class="modal">
        <h3>Update Product</h3>
        <input type="hidden" id="ProductId">
        <input type="text" id="updateProductName" placeholder="Enter product name">
        <input type="number" id="updateProductPrice" placeholder="Enter price">
        <input type="number" id="updateProductStock" placeholder="Enter stock">
        <input type="url" id="updateProductImageUrl" placeholder="Enter image URL">
        <button onclick="closeUpdatePopup()">Cancel</button>
        <button onclick="updateProduct()">Update</button>
    </div>

    <script>
        function AddProductPopup() {
            document.getElementById("addProductModal").style.display = "block";
        }

        function closePopup() {
            document.getElementById("addProductModal").style.display = "none";
        }

        function showUpdatePopup(product) {
            document.getElementById("ProductId").value = product.id;
            document.getElementById("updateProductName").value = product.name;
            document.getElementById("updateProductPrice").value = product.price;
            document.getElementById("updateProductStock").value = product.stock;
            document.getElementById("updateProductImageUrl").value = product.image_url;
            document.getElementById("updateProductModal").style.display = "block";
        }

        function closeUpdatePopup() {
            document.getElementById("updateProductModal").style.display = "none";
        }

        function getCSRFToken() {
            const name = "csrftoken=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookies = decodedCookie.split(';');

            for (let i = 0; i < cookies.length; i++) {
                let c = cookies[i].trim();
                if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
            }
            return "";
        }

        function addProduct() {
            const name = $("#productName").val();
            const price = $("#productPrice").val();
            const stock = $("#productStock").val();
            const image_url = $("#productImageUrl").val();
            const csrftoken = getCSRFToken();

            if (!name || !price || !stock || !image_url) {
                alert("Please fill all fields!");
                return;
            }

            $.ajax({
                url: 'http://127.0.0.1:8000/products/',
                method: 'POST',
                contentType: "application/json",
                headers: { "X-CSRFToken": csrftoken },
                data: JSON.stringify({ name, price, stock, image_url }),
                success: function() {
                    alert("Product added successfully!");
                    closePopup();
                    allproducts();
                },
                error: function(xhr) {
                    alert("Error adding product: " + xhr.responseText);
                }
            });
        }

        function allproducts() {
            $.ajax({
                url: 'http://127.0.0.1:8000/products/',
                method: 'GET',
                success: function(data) {
                    const productslist = $('#productslist');
                    productslist.empty();

                    data.forEach(product => {
                        productslist.append(`
                            <tr>
                                <td><img src="${product.image_url}" width="150"></td>
                                <td>${product.name}</td>
                                <td>${product.price}</td>
                                <td>${product.stock}</td>
                                <td>
                                    <button onclick='showUpdatePopup(${JSON.stringify(product)})'>Update</button>
                                    <button onclick="deleteProduct(${product.id})">Delete</button>
                                </td>
                            </tr>
                        `);
                    });
                },
                error: function() {
                    alert("Error fetching product list.");
                }
            });
        }

        function updateProduct() {
            const productId = $("#ProductId").val();
            const name = $("#updateProductName").val();
            const price = $("#updateProductPrice").val();
            const stock = $("#updateProductStock").val();
            const image_url = $("#updateProductImageUrl").val();
            const csrftoken = getCSRFToken();

            if (!name || !price || !stock || !image_url) {
                alert("Please fill all fields!");
                return;
            }

            $.ajax({
                url: `http://127.0.0.1:8000/products/${productId}/`,
                method: 'PUT',
                contentType: "application/json",
                headers: { "X-CSRFToken": csrftoken },
                data: JSON.stringify({ name, price, stock, image_url }),
                success: function() {
                    alert("Product updated successfully!");
                    closeUpdatePopup();
                    allproducts();
                },
                error: function(xhr) {
                    alert("Error updating product: " + xhr.responseText);
                }
            });
        }

        function deleteProduct(productId) {
            const csrftoken = getCSRFToken();

            if (!confirm("Are you sure you want to delete this product?")) return;

            $.ajax({
                url: `http://127.0.0.1:8000/products/${productId}/`,
                method: 'DELETE',
                headers: { "X-CSRFToken": csrftoken },
                success: function() {
                    alert("Product deleted successfully!");
                    allproducts();
                },
                error: function(xhr) {
                    alert("Error deleting product: " + xhr.responseText);
                }
            });
        }

        $(document).ready(function() {
            allproducts();
        });
    </script>

</body>

</html>
